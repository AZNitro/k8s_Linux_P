# SSH é›™é‡èªè­‰ (2FA) è¨­å®šèˆ‡æ•…éšœæŽ’é™¤æŒ‡å—

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Linux](https://img.shields.io/badge/Platform-Linux-blue.svg)](https://www.linux.org/)
[![Debian](https://img.shields.io/badge/Tested_on-Debian-red.svg)](https://www.debian.org/)

## ðŸ“‹ ç›®éŒ„

- [æ¦‚è¿°](#æ¦‚è¿°)
- [ç³»çµ±éœ€æ±‚](#ç³»çµ±éœ€æ±‚)
- [å®‰è£æ­¥é©Ÿ](#å®‰è£æ­¥é©Ÿ)
- [é…ç½®èªªæ˜Ž](#é…ç½®èªªæ˜Ž)
- [æ•…éšœæŽ’é™¤](#æ•…éšœæŽ’é™¤)
- [æ¸¬è©¦é©—è­‰](#æ¸¬è©¦é©—è­‰)
- [å®‰å…¨å»ºè­°](#å®‰å…¨å»ºè­°)
- [å¸¸è¦‹å•é¡Œ](#å¸¸è¦‹å•é¡Œ)
- [åƒè€ƒè³‡æ–™](#åƒè€ƒè³‡æ–™)

## ðŸŽ¯ æ¦‚è¿°

æœ¬æŒ‡å—è©³ç´°èªªæ˜Žå¦‚ä½•åœ¨ Debian Linux ç³»çµ±ä¸Šè¨­å®š SSH å¯†ç¢¼ + Google Authenticator é›™é‡èªè­‰ (2FA)ï¼Œæä¾›å®Œæ•´çš„å®‰è£æ­¥é©Ÿã€é…ç½®èªªæ˜Žå’Œæ•…éšœæŽ’é™¤æ–¹æ³•ã€‚

### èªè­‰æµç¨‹

1. ä½¿ç”¨è€…è¼¸å…¥ç³»çµ±å¯†ç¢¼
2. ä½¿ç”¨è€…è¼¸å…¥ Google Authenticator 6ä½é©—è­‰ç¢¼
3. æˆåŠŸå»ºç«‹ SSH é€£ç·š

## ðŸ’» ç³»çµ±éœ€æ±‚

- **ä½œæ¥­ç³»çµ±**: Debian 11/12 æˆ–ç›¸å®¹çš„ Linux ç™¼è¡Œç‰ˆ
- **SSH æœå‹™**: OpenSSH Server
- **ç¶²è·¯**: èƒ½å¤ å­˜å–ç¶²éš›ç¶²è·¯é€²è¡Œå¥—ä»¶å®‰è£
- **æ‰‹æ©Ÿæ‡‰ç”¨ç¨‹å¼**: Google Authenticator æˆ–ç›¸å®¹çš„ TOTP æ‡‰ç”¨ç¨‹å¼

## ðŸš€ å®‰è£æ­¥é©Ÿ

### æ­¥é©Ÿ 1: æ›´æ–°ç³»çµ±å¥—ä»¶

```bash
# æ›´æ–°å¥—ä»¶åˆ—è¡¨
sudo apt update

# å‡ç´šå·²å®‰è£çš„å¥—ä»¶ï¼ˆå¯é¸ï¼‰
sudo apt upgrade -y
```

### æ­¥é©Ÿ 2: å®‰è£ Google Authenticator PAM æ¨¡çµ„

```bash
# å®‰è£ Google Authenticator PAM æ¨¡çµ„
sudo apt install -y libpam-google-authenticator

# é©—è­‰å®‰è£
dpkg -l | grep google-authenticator
```

### æ­¥é©Ÿ 3: è¨­å®š Google Authenticator

```bash
# åŸ·è¡Œ Google Authenticator è¨­å®š
google-authenticator

# å»ºè­°çš„è¨­å®šé¸é …ï¼š
# - Time-based tokens: Yes (Y)
# - Update ~/.google_authenticator: Yes (Y)
# - Disallow multiple uses: Yes (Y)
# - Increase window size: No (N)
# - Enable rate-limiting: Yes (Y)
```

**é‡è¦**: è«‹å¦¥å–„ä¿å­˜ç·Šæ€¥å‚™ç”¨ç¢¼ï¼Œä¸¦ä½¿ç”¨æ‰‹æ©ŸæŽƒæ QR ç¢¼ã€‚

### æ­¥é©Ÿ 4: å‚™ä»½åŽŸå§‹é…ç½®æª”æ¡ˆ

```bash
# å‚™ä»½ SSH é…ç½®æª”æ¡ˆ
sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup.$(date +%Y%m%d_%H%M%S)

# å‚™ä»½ PAM SSH é…ç½®æª”æ¡ˆ
sudo cp /etc/pam.d/sshd /etc/pam.d/sshd.backup.$(date +%Y%m%d_%H%M%S)
```

## âš™ï¸ é…ç½®èªªæ˜Ž

### SSH é…ç½® (`/etc/ssh/sshd_config`)

ç·¨è¼¯ SSH é…ç½®æª”æ¡ˆï¼š

```bash
sudo nano /etc/ssh/sshd_config
```

ç¢ºä¿ä»¥ä¸‹è¨­å®šæ­£ç¢ºï¼š

```config
# SSH åŸ è™Ÿï¼ˆå»ºè­°ä¿®æ”¹é è¨­åŸ è™Ÿï¼‰
Port 2222

# èªè­‰è¨­å®š
PubkeyAuthentication no
PasswordAuthentication yes
ChallengeResponseAuthentication yes
KbdInteractiveAuthentication yes

# èªè­‰æ–¹æ³•ï¼ˆé—œéµè¨­å®šï¼‰
AuthenticationMethods "keyboard-interactive:pam"

# å®‰å…¨è¨­å®š
MaxAuthTries 3
```

### PAM é…ç½® (`/etc/pam.d/sshd`)

ç·¨è¼¯ PAM SSH é…ç½®æª”æ¡ˆï¼š

```bash
sudo nano /etc/pam.d/sshd
```

å®Œæ•´çš„é…ç½®å…§å®¹ï¼š

```pam
# PAM configuration for the Secure Shell service

# æ¨™æº– Unix èªè­‰
@include common-auth

# Google Authenticator 2FA - åœ¨å¯†ç¢¼é©—è­‰æˆåŠŸå¾Œé€²è¡Œ
auth required pam_google_authenticator.so nullok

# ç¦æ­¢åœ¨ /etc/nologin å­˜åœ¨æ™‚é€²è¡Œéž root ç™»å…¥
account    required     pam_nologin.so

# æ¨™æº– Unix æŽˆæ¬Š
@include common-account

# SELinux è¨­å®š
session [success=ok ignore=ignore module_unknown=ignore default=bad]        pam_selinux.so close

# è¨­å®š loginuid ç¨‹åºå±¬æ€§
session    required     pam_loginuid.so

# å»ºç«‹æ–°çš„ session keyring
session    optional     pam_keyinit.so force revoke

# æ¨™æº– Unix session è¨­å®š
@include common-session

# MOTD è¨Šæ¯
session    optional     pam_motd.so  motd=/run/motd.dynamic
session    optional     pam_motd.so noupdate

# éƒµç®±ç‹€æ…‹
session    optional     pam_mail.so standard noenv

# ä½¿ç”¨è€…é™åˆ¶
session    required     pam_limits.so

# ç’°å¢ƒè®Šæ•¸
session    required     pam_env.so
session    required     pam_env.so user_readenv=1 envfile=/etc/default/locale

# SELinux é–‹å•Ÿ
session [success=ok ignore=ignore module_unknown=ignore default=bad]        pam_selinux.so open

# æ¨™æº– Unix å¯†ç¢¼æ›´æ–°
@include common-password
```

### é©—è­‰é…ç½®ä¸¦é‡å•Ÿæœå‹™

```bash
# æ¸¬è©¦ SSH é…ç½®èªžæ³•
sudo sshd -t

# é‡æ–°è¼‰å…¥ SSH æœå‹™
sudo systemctl reload ssh

# æª¢æŸ¥æœå‹™ç‹€æ…‹
sudo systemctl status ssh
```

## ðŸ”§ æ•…éšœæŽ’é™¤

### å¸¸è¦‹å•é¡Œ 1: å¯†ç¢¼èªè­‰å¤±æ•—

**ç—‡ç‹€**: ç„¡æ³•ä½¿ç”¨å¯†ç¢¼ç™»å…¥ï¼Œé€£ç·šè¢«æ‹’çµ•

**è§£æ±ºæ–¹æ¡ˆ**:

```bash
# æª¢æŸ¥ PasswordAuthentication è¨­å®š
grep "^PasswordAuthentication" /etc/ssh/sshd_config

# å¦‚æžœé¡¯ç¤º "no"ï¼Œéœ€è¦ä¿®æ”¹ç‚º "yes"
sudo sed -i 's/^PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config

# é‡æ–°è¼‰å…¥é…ç½®
sudo systemctl reload ssh
```

### å¸¸è¦‹å•é¡Œ 2: 2FA é©—è­‰ç¢¼ç„¡æ³•ä½¿ç”¨

**ç—‡ç‹€**: å¯†ç¢¼æ­£ç¢ºä½† 2FA é©—è­‰ç¢¼è¢«æ‹’çµ•

**å¯èƒ½åŽŸå› èˆ‡è§£æ±ºæ–¹æ¡ˆ**:

1. **æ™‚é–“åŒæ­¥å•é¡Œ**:

    ```bash
    # æª¢æŸ¥æ™‚é–“åŒæ­¥ç‹€æ…‹
    timedatectl status

    # å•Ÿç”¨æ™‚é–“åŒæ­¥
    sudo systemctl enable systemd-timesyncd
    sudo systemctl start systemd-timesyncd
    ```

2. **Google Authenticator æª”æ¡ˆæ¬Šé™å•é¡Œ**:

    ```bash
    # æª¢æŸ¥æª”æ¡ˆæ¬Šé™
    ls -la ~/.google_authenticator

    # ä¿®æ­£æ¬Šé™ï¼ˆæ‡‰è©²æ˜¯ 600ï¼‰
    chmod 600 ~/.google_authenticator
    ```

3. **PAM æ¨¡çµ„é…ç½®éŒ¯èª¤**:

    ```bash
    # æª¢æŸ¥ PAM é…ç½®ä¸­æ˜¯å¦æœ‰ nullok åƒæ•¸
    grep "pam_google_authenticator" /etc/pam.d/sshd

    # æ‡‰è©²é¡¯ç¤ºï¼šauth required pam_google_authenticator.so nullok
    ```

### å¸¸è¦‹å•é¡Œ 3: èªè­‰æ–¹æ³•éŒ¯èª¤

**ç—‡ç‹€**: SSH é€£ç·šæ™‚æ²’æœ‰æç¤ºè¼¸å…¥ 2FA é©—è­‰ç¢¼

**è§£æ±ºæ–¹æ¡ˆ**:

```bash
# æª¢æŸ¥èªè­‰æ–¹æ³•è¨­å®š
grep "^AuthenticationMethods" /etc/ssh/sshd_config

# ç¢ºä¿è¨­å®šç‚ºï¼š
# AuthenticationMethods "keyboard-interactive:pam"

# å¦‚æžœä¸æ­£ç¢ºï¼Œä¿®æ”¹è¨­å®š
sudo sed -i 's/^AuthenticationMethods.*/AuthenticationMethods "keyboard-interactive:pam"/' /etc/ssh/sshd_config

# é‡æ–°è¼‰å…¥é…ç½®
sudo systemctl reload ssh
```

### å¸¸è¦‹å•é¡Œ 4: PAM æ¨¡çµ„æœªè¼‰å…¥

**ç—‡ç‹€**: ç³»çµ±æ—¥èªŒé¡¯ç¤º PAM æ¨¡çµ„è¼‰å…¥å¤±æ•—

**è§£æ±ºæ–¹æ¡ˆ**:

```bash
# é‡æ–°å®‰è£ Google Authenticator PAM æ¨¡çµ„
sudo apt remove --purge libpam-google-authenticator
sudo apt install libpam-google-authenticator

# é‡æ–°è¨­å®š Google Authenticator
google-authenticator
```

## ðŸ§ª æ¸¬è©¦é©—è­‰

### å»ºç«‹æ¸¬è©¦è…³æœ¬

```bash
cat > ~/test_ssh_2fa.sh << 'EOF'
#!/bin/bash

echo "=== SSH 2FA é…ç½®æª¢æŸ¥ ==="

echo "1. SSH æœå‹™ç‹€æ…‹ï¼š"
systemctl is-active ssh

echo "2. SSH åŸ è™Ÿç›£è½ï¼š"
ss -ln | grep :2222

echo "3. é—œéµé…ç½®æª¢æŸ¥ï¼š"
echo "   - PasswordAuthentication: $(grep "^PasswordAuthentication" /etc/ssh/sshd_config)"
echo "   - AuthenticationMethods: $(grep "^AuthenticationMethods" /etc/ssh/sshd_config)"
echo "   - ChallengeResponseAuthentication: $(grep "^ChallengeResponseAuthentication" /etc/ssh/sshd_config)"

echo "4. Google Authenticator æª”æ¡ˆï¼š"
if [ -f ~/.google_authenticator ]; then
     echo "   - æª”æ¡ˆå­˜åœ¨ï¼Œæ¬Šé™: $(stat -c %a ~/.google_authenticator)"
else
     echo "   - æª”æ¡ˆä¸å­˜åœ¨"
fi

echo "5. æ™‚é–“åŒæ­¥ï¼š"
timedatectl show --property=NTPSynchronized --value 2>/dev/null

echo "=== æ¸¬è©¦å»ºè­° ==="
echo "å¾žå…¶ä»–æ©Ÿå™¨æ¸¬è©¦é€£ç·šï¼š"
echo "ssh -p 2222 $(whoami)@$(hostname -I | awk '{print $1}')"
EOF

chmod +x ~/test_ssh_2fa.sh
```

### åŸ·è¡Œæ¸¬è©¦

```bash
# åŸ·è¡Œé…ç½®æª¢æŸ¥
~/test_ssh_2fa.sh

# æŸ¥çœ‹èªè­‰æ—¥èªŒ
sudo tail -f /var/log/auth.log
```

### å¾žå¤–éƒ¨æ©Ÿå™¨æ¸¬è©¦

```bash
# å¾žå…¶ä»–æ©Ÿå™¨åŸ·è¡Œ SSH é€£ç·šæ¸¬è©¦
ssh -p 2222 username@your_server_ip

# é æœŸæµç¨‹ï¼š
# 1. æç¤ºè¼¸å…¥å¯†ç¢¼
# 2. æç¤ºè¼¸å…¥é©—è­‰ç¢¼
# 3. æˆåŠŸç™»å…¥
```

## ðŸ”’ å®‰å…¨å»ºè­°

### 1. å¼·åŒ– SSH é…ç½®

```config
# åœ¨ /etc/ssh/sshd_config ä¸­æ·»åŠ ä»¥ä¸‹è¨­å®šï¼š

# é™åˆ¶ç™»å…¥å˜—è©¦æ¬¡æ•¸
MaxAuthTries 3

# ç¦ç”¨ç©ºå¯†ç¢¼
PermitEmptyPasswords no

# é™åˆ¶ root ç™»å…¥
PermitRootLogin no

# ä½¿ç”¨å”å®šç‰ˆæœ¬ 2
Protocol 2

# é™åˆ¶å…è¨±ç™»å…¥çš„ä½¿ç”¨è€…
AllowUsers your_username

# è¨­å®šé€£ç·šé€¾æ™‚
ClientAliveInterval 300
ClientAliveCountMax 2
```

### 2. å®‰è£ Fail2Ban

```bash
# å®‰è£ Fail2Ban
sudo apt install fail2ban

# å»ºç«‹æœ¬åœ°é…ç½®æª”æ¡ˆ
sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local

# ç·¨è¼¯é…ç½®
sudo nano /etc/fail2ban/jail.local
```

Fail2Ban SSH é…ç½®ç¯„ä¾‹ï¼š

```ini
[sshd]
enabled = true
port = 2222
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 3600
findtime = 600
```

### 3. å®šæœŸå‚™ä»½é‡è¦æª”æ¡ˆ

```bash
# å»ºç«‹å‚™ä»½è…³æœ¬
cat > ~/backup_ssh_config.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/home/$(whoami)/ssh_backups"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p "$BACKUP_DIR"

# å‚™ä»½ SSH é…ç½®
sudo cp /etc/ssh/sshd_config "$BACKUP_DIR/sshd_config_$DATE"

# å‚™ä»½ PAM é…ç½®
sudo cp /etc/pam.d/sshd "$BACKUP_DIR/pam_sshd_$DATE"

# å‚™ä»½ Google Authenticator è¨­å®š
cp ~/.google_authenticator "$BACKUP_DIR/google_authenticator_$DATE"

echo "å‚™ä»½å®Œæˆ: $BACKUP_DIR"
EOF

chmod +x ~/backup_ssh_config.sh
```

## â“ å¸¸è¦‹å•é¡Œ

### Q1: å¿˜è¨˜ Google Authenticator é©—è­‰ç¢¼æ€Žéº¼è¾¦ï¼Ÿ

**A**: å¯ä»¥ä½¿ç”¨ç·Šæ€¥å‚™ç”¨ç¢¼ç™»å…¥ï¼Œæˆ–è€…ï¼š

```bash
# å¾žæœ¬æ©Ÿçµ‚ç«¯é‡æ–°è¨­å®šï¼ˆéœ€è¦å¯¦é«”å­˜å–æ¬Šé™ï¼‰
google-authenticator

# æˆ–è€…æš«æ™‚åœç”¨ 2FAï¼ˆç·Šæ€¥æƒ…æ³ï¼‰
sudo mv ~/.google_authenticator ~/.google_authenticator.backup
```

### Q2: å¦‚ä½•ç‚ºå¤šå€‹ä½¿ç”¨è€…è¨­å®š 2FAï¼Ÿ

**A**: æ¯å€‹ä½¿ç”¨è€…éœ€è¦å€‹åˆ¥è¨­å®šï¼š

```bash
# åˆ‡æ›åˆ°ç›®æ¨™ä½¿ç”¨è€…
su - username

# åŸ·è¡Œ Google Authenticator è¨­å®š
google-authenticator

# ç¢ºä¿æª”æ¡ˆæ¬Šé™æ­£ç¢º
chmod 600 ~/.google_authenticator
```

### Q3: å¦‚ä½•åœ¨ä¸ä¸­æ–·ç¾æœ‰é€£ç·šçš„æƒ…æ³ä¸‹æ¸¬è©¦é…ç½®ï¼Ÿ

**A**: 
1. ä¿æŒç¾æœ‰ SSH é€£ç·šé–‹å•Ÿ
2. é–‹å•Ÿæ–°çš„çµ‚ç«¯è¦–çª—é€²è¡Œæ¸¬è©¦
3. ç¢ºèªæ–°é€£ç·šæˆåŠŸå¾Œå†é—œé–‰åŽŸå§‹é€£ç·š

### Q4: æ™‚é–“åŒæ­¥å•é¡Œå¦‚ä½•è§£æ±ºï¼Ÿ

**A**:

```bash
# æ‰‹å‹•åŒæ­¥æ™‚é–“
sudo ntpdate -s time.nist.gov

# æˆ–è¨­å®šè‡ªå‹•æ™‚é–“åŒæ­¥
sudo timedatectl set-ntp true
```

### Q5: å¦‚ä½•æŸ¥çœ‹è©³ç´°çš„èªè­‰æ—¥èªŒï¼Ÿ

**A**:

```bash
# å³æ™‚æŸ¥çœ‹èªè­‰æ—¥èªŒ
sudo tail -f /var/log/auth.log

# æœå°‹ç‰¹å®šçš„èªè­‰äº‹ä»¶
sudo grep "sshd" /var/log/auth.log | tail -20

# æœå°‹ PAM ç›¸é—œæ—¥èªŒ
sudo grep "pam_google_authenticator" /var/log/auth.log
```

## ðŸ“š åƒè€ƒè³‡æ–™

- [Google Authenticator PAM å®˜æ–¹æ–‡ä»¶](https://github.com/google/google-authenticator-libpam)
- [OpenSSH å®˜æ–¹æ–‡ä»¶](https://www.openssh.com/manual.html)
- [PAM æ¨¡çµ„è¨­å®šæŒ‡å—](http://www.linux-pam.org/Linux-PAM-html/)
- [Debian SSH å®‰å…¨è¨­å®š](https://wiki.debian.org/SSH)
- [TOTP æ¨™æº– RFC 6238](https://tools.ietf.org/html/rfc6238)

## ðŸ“ž æ”¯æ´èˆ‡è²¢ç»

å¦‚æžœæ‚¨åœ¨ä½¿ç”¨æœ¬æŒ‡å—æ™‚é‡åˆ°å•é¡Œï¼Œè«‹ï¼š

1. æª¢æŸ¥ [å¸¸è¦‹å•é¡Œ](#å¸¸è¦‹å•é¡Œ) ç« ç¯€
2. æŸ¥çœ‹ç³»çµ±æ—¥èªŒï¼š`sudo tail -f /var/log/auth.log`
3. åœ¨ GitHub Issues ä¸­æå‡ºå•é¡Œ

æ­¡è¿Žæäº¤ Pull Request ä¾†æ”¹å–„æœ¬æŒ‡å—ï¼

## ðŸ“„ æŽˆæ¬Š

æœ¬å°ˆæ¡ˆæŽ¡ç”¨ MIT æŽˆæ¬Šæ¢æ¬¾ - è©³è¦‹ [LICENSE](LICENSE) æª”æ¡ˆã€‚

---

**å…è²¬è²æ˜Ž**: è«‹åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­å¯¦æ–½å‰ï¼Œå…ˆåœ¨æ¸¬è©¦ç’°å¢ƒä¸­é©—è­‰æ‰€æœ‰é…ç½®ã€‚ä½œè€…ä¸å°å› ä½¿ç”¨æœ¬æŒ‡å—è€Œé€ æˆçš„ä»»ä½•æå¤±æˆ–æå®³è² è²¬ã€‚

**æœ€å¾Œæ›´æ–°**: 2025å¹´6æœˆ12æ—¥
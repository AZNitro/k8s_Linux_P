# SSH 雙重認證 (2FA) 設定與故障排除指南

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Linux](https://img.shields.io/badge/Platform-Linux-blue.svg)](https://www.linux.org/)
[![Debian](https://img.shields.io/badge/Tested_on-Debian-red.svg)](https://www.debian.org/)
[![Automation](https://img.shields.io/badge/Automation-Shell_Script-green.svg)](https://www.gnu.org/software/bash/)

## 📋 目錄

- [概述](#概述)
- [系統需求](#系統需求)
- [自動化腳本](#自動化腳本)
- [手動安裝步驟](#手動安裝步驟)
- [配置說明](#配置說明)
- [故障排除](#故障排除)
- [測試驗證](#測試驗證)
- [安全建議](#安全建議)
- [腳本功能詳解](#腳本功能詳解)
- [常見問題](#常見問題)
- [參考資料](#參考資料)

## 🎯 概述

本指南詳細說明如何在 Debian Linux 系統上設定 SSH 密碼 + Google Authenticator 雙重認證 (2FA)，提供完整的自動化腳本和手動安裝步驟、配置說明和故障排除方法。

### 認證流程

1. 使用者輸入系統密碼
2. 使用者輸入 Google Authenticator 6位驗證碼
3. 成功建立 SSH 連線

### 新增功能特色

- 🚀 **完全自動化** - 一鍵設定所有配置
- 📊 **進度顯示** - 視覺化進度條
- 🛡️ **自動備份** - 完整配置備份機制
- 🔧 **多種腳本** - 測試、備份、還原腳本
- ⚠️ **錯誤處理** - 完善的錯誤恢復機制
- 📝 **詳細日誌** - 完整操作記錄

## 💻 系統需求

- **作業系統**: Debian 11/12 或相容的 Linux 發行版
- **SSH 服務**: OpenSSH Server
- **網路**: 能夠存取網際網路進行套件安裝
- **手機應用程式**: Google Authenticator 或相容的 TOTP 應用程式
- **權限需求**: sudo 權限（非 root 用戶執行）

## 🤖 自動化腳本

### 快速開始

```bash
# 下載並執行自動化設定腳本
wget https://raw.githubusercontent.com/AZNitro/k8s_Linux_P/main/Linux/test.sh
chmod +x test.sh
./test.sh
```

### 腳本特色

```bash
╔══════════════════════════════════════════════════════════════╗
║                     SSH 2FA 自動化設定腳本                      ║
║              SSH 雙重認證 (密碼 + Google Authenticator)          ║
║                                                              ║
║  版本: 2.0                     作者: Chen YouShen              ║
║  支援系統: Debian 11/12        最後更新: 2025-07-04            ║
╚══════════════════════════════════════════════════════════════╝
```

#### 自動化流程

1. **系統檢查** - 驗證環境和權限
2. **套件更新** - 更新系統套件
3. **安裝模組** - 安裝 Google Authenticator PAM 模組
4. **配置設定** - 自動設定 Google Authenticator
5. **備份檔案** - 自動備份原始配置
6. **SSH 配置** - 配置 SSH 設定和端口
7. **PAM 配置** - 配置 PAM 認證模組
8. **服務重啟** - 重新載入 SSH 服務
9. **腳本生成** - 建立測試、備份、還原腳本
10. **最終驗證** - 執行完整配置檢查

#### 進度顯示

```bash
進度: [██████████████████████████████████████████████████] 100% - 建立還原腳本
```

## 🚀 手動安裝步驟

如果您偏好手動安裝，可以按照以下步驟進行：

### 步驟 1: 更新系統套件

```bash
# 更新套件列表
sudo apt update

# 升級已安裝的套件（可選）
sudo apt upgrade -y
```

### 步驟 2: 安裝 Google Authenticator PAM 模組

```bash
# 安裝 Google Authenticator PAM 模組
sudo apt install -y libpam-google-authenticator

# 驗證安裝
dpkg -l | grep google-authenticator
```

### 步驟 3: 設定 Google Authenticator

```bash
# 執行 Google Authenticator 設定
google-authenticator

# 建議的設定選項：
# - Time-based tokens: Yes (Y)
# - Update ~/.google_authenticator: Yes (Y)
# - Disallow multiple uses: Yes (Y)
# - Increase window size: No (N)
# - Enable rate-limiting: Yes (Y)
```

**重要**: 請妥善保存緊急備用碼，並使用手機掃描 QR 碼。

### 步驟 4: 備份原始配置檔案

```bash
# 建立備份目錄
mkdir -p ~/ssh_2fa_backups

# 備份 SSH 配置檔案
sudo cp /etc/ssh/sshd_config ~/ssh_2fa_backups/sshd_config.backup.$(date +%Y%m%d_%H%M%S)

# 備份 PAM SSH 配置檔案
sudo cp /etc/pam.d/sshd ~/ssh_2fa_backups/pam_sshd.backup.$(date +%Y%m%d_%H%M%S)
```

## ⚙️ 配置說明

### SSH 配置 (`/etc/ssh/sshd_config`)

自動化腳本會智能配置以下設定：

```config
# SSH 埠號（腳本會詢問是否自定義）
Port 2222

# 認證設定
PasswordAuthentication yes
ChallengeResponseAuthentication yes
KbdInteractiveAuthentication yes

# 認證方法（關鍵設定）
AuthenticationMethods "keyboard-interactive:pam"

# 公鑰認證選項（腳本會詢問）
# 選項 1: PubkeyAuthentication no (僅密碼+2FA)
# 選項 2: PubkeyAuthentication yes + AuthenticationMethods "publickey,keyboard-interactive:pam"

# 安全設定
MaxAuthTries 3
```

#### SSH 配置選項說明

腳本提供以下選擇：

**選項 1: 禁用公鑰認證**
- 僅使用密碼 + 2FA 認證
- 更簡單但安全性略低
- 適合個人使用環境

**選項 2: 保留公鑰認證**
- 支援公鑰 + 密碼 + 2FA 混合認證
- 最高安全等級
- 適合生產環境

### PAM 配置 (`/etc/pam.d/sshd`)

腳本會自動在 PAM 配置中添加 Google Authenticator：

```pam
# PAM configuration for the Secure Shell service

# 標準 Unix 認證
@include common-auth

# Google Authenticator 2FA - 腳本自動添加
# nullok 選項設定：
# - 包含 nullok：允許未設定 2FA 的使用者僅用密碼登入（設定階段建議）
# - 移除 nullok：強制所有使用者必須設定 2FA 才能登入（生產環境建議）
auth required pam_google_authenticator.so nullok

# 其他標準 PAM 配置...
@include common-account
@include common-session
@include common-password
```

#### PAM nullok 選項

腳本會詢問您的偏好：

**包含 nullok (推薦用於設定階段)**
- 允許未設定 2FA 的使用者登入
- 避免意外鎖定
- 便於逐步部署

**移除 nullok (推薦用於生產環境)**
- 強制所有使用者必須使用 2FA
- 最高安全級別
- 確保完整保護

### 自動驗證配置

腳本會自動執行以下驗證：

```bash
# 測試 SSH 配置語法
sudo sshd -t

# 重新載入 SSH 服務
sudo systemctl reload ssh

# 檢查服務狀態
sudo systemctl status ssh

# 檢查端口監聽
ss -tlnp | grep :2222
```

## 🔧 故障排除

### 自動故障排除

腳本內建錯誤處理機制，會自動：

1. **配置驗證** - 檢查 SSH 配置語法
2. **服務檢查** - 確認服務正常運行
3. **端口檢查** - 驗證端口監聽狀態
4. **權限修正** - 自動設定正確權限
5. **錯誤回復** - 提供還原腳本

### 常見問題自動修復

腳本會自動處理以下問題：

#### 問題 1: 套件安裝失敗

```bash
# 腳本會自動重試安裝
sudo apt update
sudo apt install -y libpam-google-authenticator
```

#### 問題 2: 配置衝突

```bash
# 腳本會檢查現有配置並詢問是否覆蓋
if grep -q "pam_google_authenticator.so" /etc/pam.d/sshd; then
    log_warning "PAM Google Authenticator 配置已存在"
    if confirm "是否要重新配置？" "n"; then
        # 移除現有配置並重新設定
    fi
fi
```

#### 問題 3: 權限問題

```bash
# 腳本會自動設定正確權限
chmod 600 ~/.google_authenticator
```

### 手動故障排除

如果遇到腳本未能處理的問題：

#### 常見問題 1: 2FA 驗證碼無法使用

**症狀**: 密碼正確但 2FA 驗證碼被拒絕

**解決方案**:

1. **時間同步問題**:

    ```bash
    # 檢查時間同步狀態
    timedatectl status

    # 啟用時間同步
    sudo systemctl enable systemd-timesyncd
    sudo systemctl start systemd-timesyncd
    ```

2. **檔案權限問題**:

    ```bash
    # 檢查檔案權限
    ls -la ~/.google_authenticator

    # 修正權限（應該是 600）
    chmod 600 ~/.google_authenticator
    ```

#### 常見問題 2: SSH 連線被拒絕

**症狀**: 無法建立 SSH 連線

**解決方案**:

```bash
# 使用腳本生成的還原腳本
~/restore_ssh_config.sh

# 或手動檢查配置
sudo sshd -t
sudo systemctl status ssh
```

## 🧪 測試驗證

### 自動生成的測試腳本

腳本會自動建立完整的測試腳本：

```bash
~/test_ssh_2fa.sh
```

#### 測試腳本內容

```bash
#!/bin/bash
# SSH 2FA 配置檢查腳本

echo "=============================================="
echo "         SSH 2FA 配置檢查報告"
echo "=============================================="

# 1. SSH 服務狀態檢查
# 2. SSH 端口監聽檢查
# 3. 關鍵配置檢查
# 4. Google Authenticator 檔案檢查
# 5. PAM 配置檢查
# 6. 時間同步狀態檢查
```

### 執行測試

```bash
# 執行配置檢查
~/test_ssh_2fa.sh

# 預期輸出範例：
# ✓ SSH 服務運行中
# ✓ SSH 服務正在監聽端口 2222
# ✓ 檔案存在，權限: 600
# ✓ PAM Google Authenticator 已配置
# ✓ 時間同步正常
```

### 連線測試

```bash
# 從其他機器執行 SSH 連線測試
ssh -p 2222 username@your_server_ip

# 預期流程：
# 1. 提示輸入密碼
# 2. 提示輸入驗證碼 (Verification code:)
# 3. 成功建立連線
```

## 🔒 安全建議

### 自動安全工具安裝

腳本會詢問是否安裝額外安全工具：

#### Fail2Ban 自動配置

```bash
# 腳本會自動配置 Fail2Ban
[sshd]
enabled = true
port = 2222  # 使用自定義端口
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 3600
findtime = 600
```

### 強化 SSH 配置選項

腳本支援以下安全配置：

```config
# 限制登入嘗試次數
MaxAuthTries 3

# 禁用空密碼
PermitEmptyPasswords no

# 限制 root 登入（可選）
PermitRootLogin no

# 設定連線逾時
ClientAliveInterval 300
ClientAliveCountMax 2
```

### 自動備份機制

腳本會建立完整的備份系統：

#### 自動備份腳本

```bash
~/backup_ssh_config.sh
```

#### 緊急還原腳本

```bash
~/restore_ssh_config.sh
```

## 🎛️ 腳本功能詳解

### 核心功能模組

#### 1. 系統檢查模組

```bash
check_system() {
    # 檢查用戶權限
    # 檢查作業系統
    # 檢查網路連線
    # 檢查必要命令
}
```

#### 2. 進度顯示模組

```bash
show_progress() {
    # 視覺化進度條
    # 步驟名稱顯示
    # 百分比計算
}
```

#### 3. 配置管理模組

```bash
configure_ssh() {
    # 智能配置檢測
    # 備份原始設定
    # 語法驗證
    # 服務重啟
}
```

#### 4. 錯誤處理模組

```bash
error_handler() {
    # 錯誤日誌記錄
    # 自動清理臨時檔案
    # 提供解決建議
}
```

### 互動式選項

腳本提供以下互動選擇：

1. **SSH 端口設定**
   - 使用預設端口 2222
   - 自定義端口 (1024-65535)

2. **公鑰認證選擇**
   - 禁用公鑰認證（僅密碼+2FA）
   - 保留公鑰認證（混合認證）

3. **PAM nullok 設定**
   - 允許模式（設定階段建議）
   - 強制模式（生產環境建議）

4. **額外安全工具**
   - 安裝 Fail2Ban
   - 跳過額外工具

### 日誌記錄

腳本會建立詳細的日誌檔案：

```bash
LOG_FILE="/tmp/ssh_2fa_setup_$(date +%Y%m%d_%H%M%S).log"
```

#### 日誌內容包含

- 時間戳記
- 操作級別（INFO, SUCCESS, WARNING, ERROR）
- 詳細操作記錄
- 錯誤追蹤資訊

## ❓ 常見問題

### Q1: 腳本執行失敗怎麼辦？

**A**: 腳本內建錯誤處理機制：

```bash
# 查看詳細日誌
cat /tmp/ssh_2fa_setup_*.log

# 使用還原腳本
~/restore_ssh_config.sh

# 重新執行腳本
./test.sh
```

### Q2: 如何自定義腳本設定？

**A**: 可以修改腳本開頭的全域變數：

```bash
# 修改預設 SSH 端口
SSH_PORT=3333

# 修改備份目錄
BACKUP_DIR="$HOME/my_ssh_backups"
```

### Q3: 忘記 Google Authenticator 驗證碼怎麼辦？

**A**: 多種解決方案：

```bash
# 方法 1: 使用緊急備用碼登入

# 方法 2: 從本機終端重新設定
google-authenticator

# 方法 3: 暫時停用 2FA（緊急情況）
sudo mv ~/.google_authenticator ~/.google_authenticator.backup

# 方法 4: 使用還原腳本完全還原
~/restore_ssh_config.sh
```

### Q4: 如何為多個使用者設定 2FA？

**A**: 每個使用者需要個別執行：

```bash
# 切換到目標使用者
su - username

# 重新執行腳本或手動設定
google-authenticator
chmod 600 ~/.google_authenticator
```

### Q5: 如何在不中斷現有連線的情況下測試？

**A**: 腳本會自動提醒安全測試流程：

1. 保持當前 SSH 連線開啟
2. 開啟新的終端視窗進行測試
3. 確認新連線成功後再關閉原始連線

### Q6: 腳本支援哪些作業系統？

**A**: 主要支援 Debian 系列：

- Debian 11/12
- Ubuntu 20.04/22.04
- 其他基於 Debian 的發行版

### Q7: 如何查看詳細的認證日誌？

**A**: 使用以下命令：

```bash
# 即時查看認證日誌
sudo tail -f /var/log/auth.log

# 搜尋 SSH 相關事件
sudo grep "sshd" /var/log/auth.log | tail -20

# 搜尋 PAM 相關日誌
sudo grep "pam_google_authenticator" /var/log/auth.log
```

### Q8: 腳本生成了哪些額外工具？

**A**: 腳本會自動生成三個實用工具：

```bash
# 測試腳本 - 檢查配置狀態
~/test_ssh_2fa.sh

# 備份腳本 - 備份當前配置
~/backup_ssh_config.sh  

# 還原腳本 - 還原到設定前狀態
~/restore_ssh_config.sh
```

## 📚 參考資料

- [Google Authenticator PAM 官方文件](https://github.com/google/google-authenticator-libpam)
- [OpenSSH 官方文件](https://www.openssh.com/manual.html)
- [PAM 模組設定指南](http://www.linux-pam.org/Linux-PAM-html/)
- [Debian SSH 安全設定](https://wiki.debian.org/SSH)
- [TOTP 標準 RFC 6238](https://tools.ietf.org/html/rfc6238)
- [Fail2Ban 官方文件](https://www.fail2ban.org/wiki/index.php/Main_Page)

## 📞 支援與貢獻

如果您在使用本指南或腳本時遇到問題，請：

1. 檢查 [常見問題](#常見問題) 章節
2. 查看腳本日誌：`cat /tmp/ssh_2fa_setup_*.log`
3. 查看系統日誌：`sudo tail -f /var/log/auth.log`
4. 在 GitHub Issues 中提出問題

歡迎提交 Pull Request 來改善本指南和腳本！

### 腳本改進建議

- 支援更多 Linux 發行版
- 添加圖形化介面選項
- 整合更多安全工具
- 支援批量使用者設定

## 📄 授權

本專案採用 MIT 授權條款 - 詳見 [LICENSE](LICENSE) 檔案。

---

**免責聲明**: 請在生產環境中實施前，先在測試環境中驗證所有配置。作者不對因使用本指南或腳本而造成的任何損失或損害負責。

**腳本版本**: 2.0  
**最後更新**: 2025年7月4日  
**維護者**: Chen YouShen

---

## 🎯 快速參考

### 一鍵執行命令

```bash
# 下載並執行自動化腳本
curl -sSL https://raw.githubusercontent.com/AZNitro/k8s_Linux_P/main/Linux/test.sh | bash
```

### 腳本執行後的檔案位置

```bash
# 主要配置檔案
/etc/ssh/sshd_config          # SSH 主配置
/etc/pam.d/sshd              # PAM 配置
~/.google_authenticator      # 2FA 設定檔

# 腳本生成的工具
~/test_ssh_2fa.sh           # 測試腳本
~/backup_ssh_config.sh      # 備份腳本  
~/restore_ssh_config.sh     # 還原腳本

# 備份目錄
~/ssh_2fa_backups/          # 所有備份檔案

# 日誌檔案
/tmp/ssh_2fa_setup_*.log    # 設定日誌
```

### 緊急情況處理

```bash
# 如果無法登入，使用本機終端：

# 1. 停用 2FA
sudo mv ~/.google_authenticator ~/.google_authenticator.disabled

# 2. 還原原始配置
~/restore_ssh_config.sh

# 3. 重新載入 SSH
sudo systemctl reload ssh
```